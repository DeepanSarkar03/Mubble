name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

# ─────────────────────────────────────────────────────────────────────────────
# Shared steps are extracted via a reusable workflow pattern where possible.
# All three jobs (Windows, macOS, Linux) run in parallel on a tag push.
# ─────────────────────────────────────────────────────────────────────────────

jobs:
  # ── Windows portable .exe ──────────────────────────────────────────────────
  release-windows:
    name: Windows (portable x64)
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install

      - name: Build packages
        run: pnpm run build

      # Build unpacked dir (avoids NSIS code-signing symlink errors).
      # The resulting Mubble.exe is a fully self-contained Electron binary.
      - name: Build Electron app (Windows portable)
        run: |
          cd apps/desktop
          npm config set cache C:\Users\runneradmin\.npm
          npx electron-builder --win --dir -c.win.certificateFile="" 2>&1 | Select-String -Pattern "(packaging|completed|error)" | Write-Host
          if (-not (Test-Path "..\..\release\win-unpacked\Mubble.exe")) { exit 1 }
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create portable archive
        run: |
          cd release
          tar -czf "Mubble-${{ github.ref_name }}-Windows-portable-x64.tar.gz" win-unpacked/
          Get-Item "Mubble-${{ github.ref_name }}-Windows-portable-x64.tar.gz" | Format-List Name, @{n='Size';e={[math]::Round($_.Length/1MB,1).ToString()+'MB'}}
        shell: pwsh

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release/Mubble-${{ github.ref_name }}-Windows-portable-x64.tar.gz
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ── macOS DMG (unsigned) ───────────────────────────────────────────────────
  release-macos:
    name: macOS (DMG, unsigned)
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install

      - name: Build packages
        run: pnpm run build

      # Build unsigned DMG. macOS Gatekeeper will warn about unsigned apps;
      # users can right-click → Open to bypass the quarantine prompt.
      # To notarise: set CSC_LINK, CSC_KEY_PASSWORD, APPLE_ID, etc. as secrets.
      - name: Build Electron app (macOS DMG)
        run: |
          cd apps/desktop
          npx electron-builder --mac dmg --publish never
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Uncomment when code-signing certs are configured:
          # CSC_LINK: ${{ secrets.CSC_LINK }}
          # CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}
          # APPLE_ID: ${{ secrets.APPLE_ID }}
          # APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          # APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}

      - name: Rename DMG with version
        run: |
          cd release
          for f in *.dmg; do
            mv "$f" "Mubble-${{ github.ref_name }}-macOS.dmg"
          done
          ls -lh *.dmg

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release/Mubble-${{ github.ref_name }}-macOS.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ── Linux AppImage ─────────────────────────────────────────────────────────
  release-linux:
    name: Linux (AppImage x64)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential python3 libopenjp2-tools \
            libgtk-3-dev libnotify-dev libnss3 libxss1 libxtst6 xauth \
            xvfb libgbm-dev

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install

      - name: Build packages
        run: pnpm run build

      - name: Build Electron app (Linux AppImage)
        run: |
          cd apps/desktop
          npx electron-builder --linux AppImage --publish never
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Rename AppImage with version
        run: |
          cd release
          for f in *.AppImage; do
            mv "$f" "Mubble-${{ github.ref_name }}-Linux-x64.AppImage"
          done
          ls -lh *.AppImage

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release/Mubble-${{ github.ref_name }}-Linux-x64.AppImage
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
